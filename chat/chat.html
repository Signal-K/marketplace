<html>
    <head>
        <title>Chat page</title>
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
        <script src="https://npmcdn.com/moralis@1.9.1/dist/moralis.js"></script>
    </head>
    <body>
        <p>CHAT</p>

        <div id="chatHistory">
            <ul id="historyList"></ul>
        </div>

        <input type="text" id="chatInput" /?
        <input type="button" value="Send message" id="sendButton" />

        <script>
            // Connect to the Moralis server
            Moralis.initialize("");
            Moralis.serverURL = "";

            /*  Some notes
                * Messages have to be sent through Moralis cloud functions
            */

            const queryString = window.location.search;
            const params = new URLSearchParams(queryString);
            const chatId = urlParams.get('id')
            console.log(chatId);

            async function init() {
                let query = new Moralis.Query('Message'); // live query on the message class from Moralis backend
                let subscription = await query.subscribe();
                const historyList = document.getElementById("historyList");

                subscription.on('create', (object) => {
                    if (object.get("group") == chatId) {
                        var listItem = document.createElement('li');
                        listItem.innerHTML = object.get("sender") + " says: <br>" + object.get("text") + "<br>"
                        historyList.appendChild(listItem);
                    }
                });
            }

            // Retrieve the group chat's list of messages
            async function getHistory() {
                const Message = Moralis.Object.extend("Message");
                const query = new Moralis.Query(Message);
                query.equalTo("group", chatId);
                const results = await query.find();
                const historyList = document.getElementById("historyList");

                for (let i = 0; i < results.length; i++) { // print the message history to the frontend
                    const object = results[i];
                    var listItem = document.createElement('li');
                    listItem.innerHTML = object.get("sender") + " says:<br>" + object.get('text')+"<br>";
                    historyList.appendChild(listItem);
                }
            }
            init();
            getHistory();

            async function sendMessage() {
                let user = Moralis.User.current();
                let message = document.getElementById("chatInput").value;
                if (message && message.length > 0) {
                    const Message = Moralis.Object.extend("Message");
                    const m = new Message();
                    m.set("sender", user.get("ethAddress")); // m -> entry in the db
                    m.set("text", message); // message -> text of the message
                    m.set("group", chatId);
                    m.save();
                    console.log("Sending message " + message + " from " + user.get("ethAddress") + " in group " + chatId);
                }
            }

            document.getElementById("sendButton").onClick = sendMessage;
        </script>
    </body>
</html>